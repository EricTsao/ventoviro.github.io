<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" href="../../../media/images/favicon.ico" />

        <title>Model and Database | Windwalker - A Modern PHP Framework</title>

        <!-- Uikit core CSS -->
        <link href="//cdnjs.cloudflare.com/ajax/libs/uikit/2.15.0/css/uikit.min.css" rel="stylesheet">
                <link rel="stylesheet" href="../../../media/css/prism.css" />

        <!-- Custom styles for this template -->
        <link href="../../../media/css/main.css" rel="stylesheet">

        <meta name="description" content="">
        <meta name="generator" content="The Time Machine">

        <meta property="og:title" content="Model and Database | Windwalker - A Modern PHP Framework">
        <meta property="og:site_name" content="Windwalker Framework">

            

    <style>
        #header {
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 500;
            border-bottom: 1px solid #eee;
        }

        body {
            padding-top: 70px;
        }
    </style>

        <!-- Bootstrap core JavaScript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="../../../media/js/jquery.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/uikit/2.15.0/js/uikit.min.js"></script>
                                <script src="../../../media/js/prism.js"></script>
        <script>
            $(document).ready(function() {

                $('.article-content pre code').each(function(i, block) {
                    var $this = $(this);

                    $this.attr('class', 'language-' + $this.attr('class'));
                });
            });
        </script>

            <script src="../../../media/js/doc.js"></script>
    </head>
    <body class="">
    <nav id="header" class="uk-navbar uk-navbar-attached">
        <div class="uk-container uk-container-center">

            <a id="big-logo" class="uk-navbar-brand uk-hidden-small" href="../../../">
                <img class="uk-margin uk-margin-remove" src="../../../media/images/logo/windwalker-logo.png" title="Asukademy" alt="Asukademy">
            </a>

            <a href="#" class="uk-navbar-toggle uk-visible-small" data-uk-toggle="{target:'#mainmenu', cls: 'uk-hidden-small'}"></a>

            <a id="small-logo" class="uk-navbar-brand uk-navbar-center uk-visible-small" href="../../../">
                <img class="uk-margin uk-margin-remove" style="max-width: 95%;" src="../../../media/images/logo/windwalker-logo.png" title="Asukademy" alt="Asukademy">
            </a>

                <div id="version-switcher" class="uk-button-dropdown uk-float-right" data-uk-dropdown="">
        <a class="uk-button uk-button-primary" href="../../../documentation/3.x/start/getting-started.html">
            3.x <i class="uk-icon-caret-down"></i>
        </a>

        <div class="uk-dropdown">
            <ul class="uk-nav uk-nav-dropdown">
                <li class="uk-active">
                    <a href="../../../documentation/3.x/mvc/model-database.html">3.x</a>
                </li>

                <li class="">
                    <a href="../../../documentation/2.1/mvc/model-database.html">2.1</a>
                </li>
            </ul>
        </div>
    </div>

            <ul id="mainmenu" class="uk-navbar-nav uk-float-right uk-hidden-small">
                <li class="">
                    <a href="../../../about/">
                        <span class="menu-item-title">About</span>
                    </a>
                </li>

                <li class="uk-active">
                    <a href="../../../documentation/3.x/start/installation.html">
                        <span class="menu-item-title">Documentation</span>
                    </a>
                </li>

                <li class="">
                    <a href="../../../rad/start/introduction.html">
                        <span class="menu-item-title">RAD</span>
                    </a>
                </li>

                <li class="">
                    <a href="https://github.com/ventoviro/windwalker" target="_blank">
                        <span class="menu-item-title">GitHub</span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>

    <section id="banner">
        <div class="banner-inner">
                <div class="uk-container uk-container-center banner-inner-title">
        <h1>Model and Database</h1>
    </div>
        </div>
    </section>

    <div id="main-body">
            <div class="uk-container uk-container-center">
        <div class="uk-grid">
                <div class="uk-width-medium-1-4 uk-container-center">
        <ul class="uk-nav uk-nav-side side-menu side-bar" data-uk-nav="">
    
                
        <li class="uk-nav-header">Start</li>
                    <li class="">
                <a href="../../../documentation/3.x/start/installation.html">Installation</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/start/getting-started.html">Getting Started</a>
            </li>
        
    <li class="uk-nav-divider"></li>
       <li class="uk-nav-header">Core</li>
                    <li class="">
                <a href="../../../documentation/3.x/core/routing.html">Routing</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/core/package-system.html">Packages</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/core/config.html">Config &amp; Setting</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/core/request-input.html">Request and Input</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/core/psr7-middlewares.html">Psr7 and Middlewares</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/core/ioc-container.html">IoC Container</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/core/service-provider.html">Service Provider</a>
            </li>
        
    <li class="uk-nav-divider"></li>
       <li class="uk-nav-header">MVC</li>
                    <li class="">
                <a href="../../../documentation/3.x/mvc/use-controller.html">Use Controller</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/mvc/class-resolvers.html">Class Resolvers</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/mvc/view-templating.html">View and Templating</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/mvc/edge.html">Edge Templates</a>
            </li>
                    <li class="uk-active">
                <a href="../../../documentation/3.x/mvc/model-database.html">Model and Database</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/mvc/view-model.html">ViewModel</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/mvc/uri-route-building.html">URI and Route Building</a>
            </li>
        
    <li class="uk-nav-divider"></li>
       <li class="uk-nav-header">Database</li>
                    <li class="">
                <a href="../../../documentation/3.x/db/basic.html">Basic Usage</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/db/read-write.html">Read and Write</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/db/table-schema.html">Table and Schema</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/db/query-builder.html">Query Builder</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/db/active-record.html">ActiveRecord</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/db/datamapper.html">DataMapper</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/db/migration.html">Migration And Seeding</a>
            </li>
        
    <li class="uk-nav-divider"></li>
       <li class="uk-nav-header">Services</li>
                    <li class="">
                <a href="../../../documentation/3.x/services/authentication.html">Authentication</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/authorisation.html">Authorisation</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/asset.html">Asset Manager</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/caching.html">Caching</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/datetime.html">DateTime</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/environment.html">Environment</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/events.html">Events</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/languages.html">Languages</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/session.html">Session</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/widget-renderer.html">Widget and Renderer</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/mailer.html">Mailer</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/debugging.html">Debugging and Logging</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/services/error-handling.html">Error Handling</a>
            </li>
        
    <li class="uk-nav-divider"></li>
       <li class="uk-nav-header">Console</li>
                    <li class="">
                <a href="../../../documentation/3.x/console/console-basic.html">Basic Usage</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/console/custom-commands.html">Custom Commands</a>
            </li>
        
    <li class="uk-nav-divider"></li>
       <li class="uk-nav-header">More</li>
                    <li class="">
                <a href="../../../documentation/3.x/more/data-object.html">Data Object</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/http-stream.html">Http and Stream</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/structure.html">Structure Object</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/crypt.html">Crypt</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/form-builder.html">Form Builder</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/form-definition.html">Form Definition</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/filesystem.html">Filesystem</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/html-builder.html">HTML Builder</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/pagination.html">Pagination</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/string.html">String</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/tests.html">Tests</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/validation.html">Validation</a>
            </li>
                    <li class="">
                <a href="../../../documentation/3.x/more/more-packages.html">More Packages</a>
            </li>
        
    <li class="uk-nav-divider"></li>
   </ul>
    </div>

            <div class="uk-width-medium-3-4 uk-container-center">
                <article class="article-content">
                    <h2>What is Model</h2>

<p>Model is an implementation of repository pattern in Windwalker, it maintains some low-layer DB handler like DataMapper
or ActiveRecord and help us do more database operation logic.</p>

<h3>ModelRepository</h3>

<p><code>ModelRepository</code> is a very simple class without and DB access. This is an example of using it:</p>

<pre><code class="php">use Windwalker\Core\Model\ModelRepository;

class MyModel extends ModelRepository
{
    public function getItem()
    {
        return file_get_contents(__DIR__ . '/data.md');
    }

    public function save($content)
    {
        file_put_contents(__DIR__ . '/data.md', $content);
    }
}
</code></pre>

<pre><code class="php">// In controller
$model = new MyModel;

$item = $model-&gt;getItem();

// Do something...

$model-&gt;save($item);
</code></pre>

<p>Set source to ModelRepository:</p>

<pre><code class="php">// FileFinder is just an example
$model = new MyModel(null, null, new FileFinder);

// In model
$this-&gt;source-&gt;find(...);
</code></pre>

<h2>Database Model</h2>

<p>We can use <code>DatabaseModelRepository</code> to operate Database, here is a CRUD example, <code>db</code> is preset in Model so we can get it quickly:</p>

<pre><code class="php">use Windwalker\Core\Model\DatabaseModelRepository;

class FlowerModel extends DatabaseModelRepository
{
    public function getItem($id)
    {
        $query = $this-&gt;db-&gt;getQuery(true);

        $query-&gt;select('*')
            -&gt;from('flowers')
            -&gt;where('id = ' . $id);

        return $this-&gt;db-&gt;setQuery($query)-&gt;loadOne();
    }

    public function save($data)
    {
        if ($data-&gt;id)
        {
            $this-&gt;db-&gt;getWriter()-&gt;updateOne('flowers', $data, 'id');
        }
        else
        {
            $this-&gt;db-&gt;getWriter()-&gt;insertOne('flowers', $data);
        }
    }

    public function delete($id)
    {
        $query = $this-&gt;db-&gt;getQuery(true);

        $query-&gt;delete('flowers')
            -&gt;where('id = ' . $id);

        return $this-&gt;db-&gt;setQuery($query)-&gt;execute();
    }
}
</code></pre>

<h2>Use DataMapper</h2>

<p>DataMapper is a easy way to help us operate database:</p>

<pre><code class="php">use Windwalker\Core\Model\DatabaseModelRepository;

class FlowerModel extends DatabaseModelRepository
{
    // Add table to make sure DataMapper use corrent DB table.
    protected $table = 'flowers';

    // Keys is optional since Model will set ['id'] as default
    // But you can override id if you use `uuid` or multiple primary key.
    protected $keys = 'id';

    public function getItem($id)
    {
        return $this-&gt;getDataMapper()-&gt;findOne($id);
    }

    public function save($data)
    {
        return $this-&gt;getDataMapper()-&gt;saveOne($data);
    }

    public function delete($id)
    {
        return $this-&gt;getDataMapper()-&gt;delete($id);
    }
}
</code></pre>

<p>See <a href="../db/datamapper.html">DataMapper</a></p>

<h2>Use Record</h2>

<p>You can also use ActiveRecord to handle data saving.</p>

<pre><code class="php">use Windwalker\Core\Model\DatabaseModelRepository;

class FlowerModel extends DatabaseModelRepository
{
    // Add table to make sure Record use corrent DB table.
    protected $table = 'flowers';

    // Keys is optional since Model will set ['id'] as default
    // But you can override id if you use `uuid` or multiple primary key.
    protected $keys = 'id';

    public function getItem($id)
    {
        $record = $this-&gt;getRecord();
        $record-&gt;load($id);  // @throws NoResultException;

        return $record-&gt;dump();
    }

    public function save($data)
    {
        $record = $this-&gt;getRecord();
        $record-&gt;bind($data)
            -&gt;validate(); // @throws ValidateFailException;
            -&gt;store();

        return true;
    }

    public function delete($id)
    {
        $this-&gt;getRecord()-&gt;delete($id);

        return true;
    }
}
</code></pre>

<p>See <a href="../db/active-record.html">ActiveRecord</a></p>

<h2>Magic Method</h2>

<p>Model support a usage similar to NullObject pattern, if we call some method start with <code>get*()</code> or <code>load*()</code>, and this method not exists,
Model will not raise error but only return <code>null</code>.</p>

<pre><code class="php">use Windwalker\Core\Model\Model;

// This is default model, does not have any custom methods
$model = new Model;

// These 2 methods will only return null
$data = $model-&gt;getData();

$list = $model-&gt;loadList();
</code></pre>

<p>So, we can use default Model to provide empty data for some object but won't breaking our program.</p>

<h2>Model State</h2>

<p>Windwalker Model is stateful design, use state pattern can help ue create flexible data provider. 
For example, we can change this state to get different data.</p>

<pre><code class="php">class MyModel extends DatabaseModel
{
    // ...

    public function getUsers()
    {
        $published = $this-&gt;state-&gt;get('where.published', 1);

        $ordering  = $this-&gt;state-&gt;get('list.ordering', 'id');
        $direction = $this-&gt;state-&gt;get('list.direction', 'ASC');

        $sql = "SELECT * FROM users " .
            " WHERE published = " . $published .
            " ORDER BY " . $ordering . " " . $direction;

        try
        {
            return $this-&gt;db-&gt;setQuery($sql)-&gt;loadAll();
        }
        catch (\Exception $e)
        {
            $this-&gt;state-&gt;set('error', $e-&gt;getMessage());

            return false;
        }
    }
}

$model = new MyModel;

$state = $model-&gt;getState();

// Let's change model state
$state-&gt;set('where.published', 1);
$state-&gt;set('list.ordering', 'birth');
$state-&gt;set('list.direction', 'DESC');

$users = $model-&gt;getUsers();

if (!$users)
{
    $error = $state-&gt;get('error');
}
</code></pre>

<h5>Simple Way to Access State</h5>

<p>Using <code>get()</code> and <code>set()</code></p>

<pre><code class="php">// Same as getState()-&gt;get();
$model-&gt;get('where.author', 5);

// Same as getState()-&gt;set();
$model-&gt;set('list.ordering', 'RAND()');
</code></pre>

<h5>State ArrayAccess</h5>

<pre><code class="php">// Same as getState()-&gt;get();
$data = $model['list.ordering'];

// Same as getState()-&gt;set();
$model['list.ordering'] = 'created_time';
</code></pre>

<h2>Model Caching</h2>

<p>Windwalker Model provides runtime cache interface help us cache data in Model itself (This runtime cache only life in once
page load, will not exists in next page loading, and won't affected by global configuration).</p>

<p>This is an example to use cache in Model:</p>

<pre><code class="php">use Windwalker\Core\Model\Model;

class MyModel extends Model
{
    public function getData()
    {
        if ($this-&gt;cache-&gt;exists('item.data'))
        {
            return $this-&gt;cache-&gt;get('item.data');
        }

        $data = file_get_contents(__DIR__ . '/data.md');

        $this-&gt;cache-&gt;set('item.data', $data);

        return $data;
    }
}
</code></pre>

<h3>Generate Cache id When State Changed</h3>

<p>Model state is dynamic, so if we change state, the cache key should be refresh that we can make sure we get same data when state is same,
but get new data if state is changed.</p>

<pre><code class="php">public function getData()
{
    // Will generate a id look like: d967f4557f17dd542ece0f8a7b57b4f697c9b189
    $id = $this-&gt;getCacheId('item.data');

    if ($this-&gt;cache-&gt;exists($id))
    {
        return $this-&gt;cache-&gt;get($id);
    }

    $data = file_get_contents(__DIR__ . '/' . $this-&gt;state-&gt;get('file.name'));

    $this-&gt;cache-&gt;set($id, $data);

    return $data;
}
</code></pre>

<h3>Custom Cache id Rule</h3>

<p>If you trace <code>getCacheId()</code> at the parent, you will see:</p>

<pre><code class="php">public function getCacheId($id = null)
{
    $id = $id . json_encode($this-&gt;state-&gt;toArray());

    return sha1($id);
}
</code></pre>

<p>So override cache id rule is very easy, we can add some custom elements to hash:</p>

<pre><code class="php">public function getCacheId($id = null)
{
    $id .= json_encode($this-&gt;get('query.filter'));
    $id .= json_encode($this-&gt;get('query.search'));
    $id .= json_encode($this-&gt;get('query.where'));
    $id .= json_encode($this-&gt;get('query.having'));
    $id .= json_encode($this-&gt;get('query.ordering'));
    $id .= json_encode($this-&gt;get('query.direction'));
    $id .= json_encode($this-&gt;get('query.limit'));
    $id .= json_encode($this-&gt;get('query.start'));

    return sha1($id);
}
</code></pre>

<h3>Use Callback</h3>

<p>There is a simple way to quickly use cache, <code>fetch()</code> will auto check the cache exists or not and execute the callback to get data:</p>

<pre><code class="php">public function getData()
{
    $callback = function()
    {
        return file_get_contents(__DIR__ . '/' . $this-&gt;state-&gt;get('file.name'));
    };

    return $this-&gt;fetch('item.data', $callback);
}
</code></pre>

                        <hr />

    <p class="uk-text-center">
        Help us <a target="_blank" href="https://github.com/ventoviro/ventoviro.github.io/tree/master/.vaseman/entries/documentation/3.x/mvc/model-database.md">improve</a> this document.
    </p>
                </article>
            </div>
        </div>
    </div>
    </div>

    <footer id="footer">
        <div class="uk-container uk-container-center uk-text-center">

            <div class="footer-logo">
                <a href="#" data-uk-smooth-scroll>
                    <img src="../../../media/images/logo/windwalker-logo.png" width="150" alt="Footer LOGO">
                </a>
            </div>

            <p class="uk-text-center social-buttons">
                <a target="_blank" class="uk-icon-button uk-icon-facebook" href="javascript: void(0);"></a>

                <a target="_blank" class="uk-icon-button uk-icon-github" href="https://github.com/ventoviro/windwalker"></a>

                <a class="uk-icon-button uk-icon-envelope-o" href="mailto:asika32764@gmail.com"></a>
            </p>

            <p>
                Copyright &copy; 2016 Windwalker. All Rights Reserved.
            </p>
            <p class="back">
                <a href="#" data-uk-smooth-scroll><span class="uk-icon-chevron-up"></span> Back to Top</a>
            </p>
        </div>
    </footer>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-48372917-6', 'auto');
        ga('send', 'pageview');

    </script>

    </body>
</html>
